"use strict";var flv=function(e,t){var a={},i={type:"uri"};"string"==typeof e?e={file:e,type:"uri"}:(e={file:e,type:"file"},a.filesize=e.file.size,a.filename=e.file.name,a.filedate=e.file.lastModifiedDate,a.FLVVers=0,a.parseMetaDataBREAK=!1,a.parseFlagsBREAK=!1,a.hasVideo=!1,a.hasAudio=!1,a.hasEncrypted=!1,a.hasScript=!1,a.FileOffBuff=0,a.BuffLength=0,a.LastBuffPos=0,a.AudioFormat="",a.AudioSampling=0,a.AudioDeep=0,a.AudioMode="",a.AudioCodecId="",a.modeAAC="",a.AudioAACProfile="",a.AACnbChannels=0,a.AACConfigChannels="",a.firstStampTime="",a.lastStampTime="",a.VideoCodec="",a.VideoCodecId="",a.TagsCount=0,a.tags=[],a.AudionbB=0,a.VideonbB=0,a.ScriptTagsCount=0,a.AudioTagsCount=0,a.VideoTagsCount=0,a.tag={},a.meta={},a.onMetaData={},a.meta.pairkey="",a.factor=0,a.factordefined=!1,a.factorbug=!1);for(var n in e)i[n]=e[n];if(!i.file)return cb("No file was set");var r={};r.parse=function(e,t){function i(e,t,a){for(var i=[],n=t;t+a>n;n++){var r=e.getUint8(n).toString(16);1==r.length&&(r="0"+r),i.push(r)}return i.join("")}function n(e,t,a){for(var i=[],n=t;t+a>n;n++)i.push(String.fromCharCode(e.getUint8(n)));return i.join("")}function r(t,a,i){e.read(t,a,function(e,t){if(e)i(e);else{var a=new DataView(t);i(null,a)}})}function o(e){var t,a,i,n,r,o;t=parseInt(e/Math.pow(2,63)),a=parseInt(e/Math.pow(2,52))-t*Math.pow(2,12),n=e-a*Math.pow(2,52)-t*Math.pow(2,63),r=n.toString(2),o=1;for(var s=0;s<r.length;s++)"1"==r[r.length-1-s]&&(o+=Math.pow(2,-52+s));r=o,i=a.toString(2),o=0;for(var s=0;s<i.length;s++)"1"==i[i.length-1-s]&&(o+=Math.pow(2,s));return i=o,o=Math.pow(2,i-1024)*r,1==t&&(o=-o),o}function s(e){var t=0;if("FLV"==n(e,t,3)){a.FLVVers=e.getUint8(t+3);var i=e.getUint8(t+4);if(0!=(248&i)||0!=(2&i))return 0;4==(4&i)&&(a.hasAudio=!0),1==(1&i)&&(a.hasVideo=!0);var r=e.getUint32(t+5,!1);t=r,t+=4;var o=e.getUint32(t-4,!1);return 0!=o?0:t}return 0}function l(e,t){return a.TagsCount+=1,a.LastBuffPos=t,a.tag.flags=e.getUint8(t),a.tag.filter=(32&a.tag.flags)>>5,a.tag.tagtype=31&a.tag.flags,a.tag.datasize=16777215&e.getUint32(t,!1),a.tag.timestamp=16777215&e.getUint32(t+3,!1),a.tag.timestamp+=16777216*e.getUint8(t+7),""==a.firstStampTime&&(a.firstStampTime=a.tag.timestamp),a.lastStampTime=a.tag.timestamp,a.tag.eqzero=16777215&e.getUint32(t+7,!1),a.tag.tagtype}function f(e){if(a.meta.LevelsEnd.length>0)if("strictarray"==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].typ){if(a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].count--,0==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].count){for(a.meta.LevelsEnd.pop();"000009"==i(e,a.meta.pos,3);)a.meta.pos+=3,a.meta.LevelsEnd.pop();a.meta.nexttype=!1,a.meta.scriptdatavalue=2,a.meta.nexttag=!1}}else if("000009"!=i(e,a.meta.pos,3))2==a.meta.scriptdatavalue&&a.meta.ispairvalue||2!=a.meta.scriptdatavalue?(a.meta.ispairvalue=!1,a.meta.nexttype=!1,a.meta.scriptdatavalue=2):(a.meta.ispairvalue=!0,a.meta.nexttype=!0);else for(;"000009"==i(e,a.meta.pos,3);)a.meta.pos+=3,a.meta.LevelsEnd.pop(),a.meta.nexttype=!1,a.meta.scriptdatavalue=2,a.meta.nexttag=!1}function p(e,t){for(var a=t.length,i=0;a>i;i++)if(t[i]==e)return!0;return!1}function u(){for(var e=a,t=0;t<a.meta.LevelsEnd.length;t++)e=e[a.meta.LevelsEnd[t].chaine];return e}function d(){a.onMetaData.audiocodecid&&(isNaN(a.onMetaData.audiocodecid)||(a.factor=a.AudioCodecId/a.onMetaData.audiocodecid)),0==a.factor&&a.onMetaData.videocodecid&&(isNaN(a.onMetaData.videocodecid)||(a.factor=a.VideoCodecId/a.onMetaData.videocodecid)),0==a.factor&&a.onMetaData.duration&&(a.factor=Math.round(Math.abs((a.lastStampTime-a.firstStampTime)/1e3/a.onMetaData.duration))),0==a.factor&&a.onMetaData.videosize&&(a.factor=Math.round(a.VideonbB/Math.round(a.onMetaData.videosize))),0==a.factor&&a.onMetaData.framerate&&(a.factor=Math.round(a.VideoTagsCount/(a.lastStampTime-a.firstStampTime)*1e3/a.onMetaData.framerate)),2==a.factor?a.factordefined=!0:a.factor>0?a.factorbug=!0:a.factor=2}function m(e,t){var i=e,y=B;a.filesize-i<B&&(y=a.filesize-i),r(y,i,function(i,r){if(i)return t(i);a.BuffLength=r.byteLength,a.FileOffBuff=e;var y=0;if(0==e&&(y=s(r),0==y))return t("This is not a FLV file");for(;y+15<=a.BuffLength;){var B=l(r,y);if(B==c&&(y=a.BuffLength,a.FileOffBuff=a.filesize),B==v&&(a.AudionbB+=a.tag.datasize,a.AudioTagsCount+=1,""==a.AudioFormat)){var R=r.getUint8(y+11),k=(240&R)>>4;a.AudioCodecId=k,a.AudioFormat=A[k];var x=(12&R)>>2;a.AudioSampling=C[x];var z=(2&R)>>1;if(a.AudioDeep=E[z],a.AudioMode=F[1&R],4==k&&(a.AudioSampling=16),5==k&&(a.AudioSampling=8),10==k&&0==r.getUint8(y+12)){a.AudioAACProfile=r.getUint16(y+13,!1);var O=(63488&a.AudioAACProfile)>>11;if(7>O){a.modeAAC=w[O-1];var T=(1808&a.AudioAACProfile)>>7;13>T&&(a.AudioSampling=P[T]);var D=(120&a.AudioAACProfile)>>3;8>D&&D>0&&(a.AACnbChannels=U[D][0],a.AACConfigChannels=U[D][1]);(64&a.AudioAACProfile)>>2}else a.modeAAC="unknown"}}if(B==g&&(a.VideonbB+=a.tag.datasize,a.VideoTagsCount+=1,""==a.VideoCodec)){var R=r.getUint8(y+11),b=15&R;a.VideoCodecId=b;var V=(240&R)>>4;if(a.VideoCodec=M[b],7==b&&1==V);}if(B==h)if(a.ScriptTagsCount+=1,a.meta.pos=y+11,a.meta.LevelsEnd=[],a.meta.StringObject="",a.meta.nexttype=!0,a.meta.ispairvalue=!1,a.meta.nexttag=!0,a.meta.scriptdatavalue="",a.tag.datasize+y+11<=a.BuffLength)for(;a.meta.pos<a.tag.datasize+y+11;){if(a.meta.nexttag=!0,a.meta.nexttype&&(a.meta.scriptdatavalue=r.getUint8(a.meta.pos),a.meta.pos+=1),0==a.meta.scriptdatavalue){var N=4294967296*r.getUint32(a.meta.pos,!1);N+=r.getUint32(a.meta.pos+4,!1),a.meta.pos+=8;var I=o(N);I=parseFloat(I.toPrecision(5));var _=u();"strictarray"==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].typ?_.push(I):_[a.meta.pairkey]=I,a.meta.ispairvalue=!1,a.meta.nexttype=!0,f(r)}if(1==a.meta.scriptdatavalue){var I=!0;if(0==r.getUint8(a.meta.pos)&&(I=!1),a.meta.ispairvalue){var _=u();"strictarray"==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].typ?_.push(I):_[a.meta.pairkey]=I,a.meta.ispairvalue=!1}a.meta.pos+=1,a.meta.nexttype=!0,f(r)}if(2==a.meta.scriptdatavalue&&a.meta.nexttag){var H=r.getUint16(a.meta.pos,!1);a.meta.pos+=2;var j=n(r,a.meta.pos,H);if(a.meta.pos==y+14&&"onMetaData"!=j)a.meta.pos=a.tag.datasize+y+11;else{if(a.meta.pos+=H,a.meta.nexttype=!0,a.meta.ispairvalue){var _=u();"strictarray"==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].typ?_.push(j):_[a.meta.pairkey]=j}else a.meta.pairkey=j;f(r)}}if(3==a.meta.scriptdatavalue){var q={level:a.meta.LevelsEnd.length,typ:"object"};if(0==a.meta.LevelsEnd.length)q.chaine="onMetaData";else{q.chaine=a.meta.pairkey;var _=u();_[a.meta.pairkey]={}}a.meta.LevelsEnd.push(q),a.meta.nexttype=!1,a.meta.scriptdatavalue=2,a.meta.ispairvalue=!1}if(7==a.meta.scriptdatavalue){var I=r.getUint16(a.meta.pos,!1);if(a.meta.ispairvalue){var _=u();"strictarray"==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].typ?_.push(I):_[a.meta.pairkey]=I,a.meta.ispairvalue=!1}a.meta.pos+=2,a.meta.nexttype=!0,f(r)}if(8==a.meta.scriptdatavalue){var q=(r.getUint32(a.meta.pos,!1),{level:a.meta.LevelsEnd.length,typ:"ecma_array"});if(0==a.meta.LevelsEnd.length)q.chaine="onMetaData";else{q.chaine=a.meta.pairkey;var _=u();_[a.meta.pairkey]={}}a.meta.LevelsEnd.push(q),a.meta.nexttype=!1,a.meta.scriptdatavalue=2,a.meta.pos+=4,a.meta.ispairvalue=!1}if(10==a.meta.scriptdatavalue){var G=r.getUint32(a.meta.pos,!1),q={level:a.meta.LevelsEnd.length,count:G,typ:"strictarray"};if(0==a.meta.LevelsEnd.length)q.chaine="onMetaData";else{q.chaine=a.meta.pairkey;var _=u();_[a.meta.pairkey]=[]}a.meta.LevelsEnd.push(q),a.meta.pos+=4,a.meta.nexttype=!0,a.meta.scriptdatavalue=2,a.meta.ispairvalue=!1}if(11==a.meta.scriptdatavalue){var K=r.getUint32(a.meta.pos,!1),X=r.getUint32(a.meta.pos,!1),J=r.getUint16(a.meta.pos,!1);J>32768&&(J-=65536);var Q="date("+K.toString()+","+X.toString()+","+J.toString()+")";if(a.meta.ispairvalue){var _=u();"strictarray"==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].typ?_.push(Q):_[a.meta.pairkey]=Q,a.meta.ispairvalue=!1}a.meta.pos+=10,a.meta.nexttype=!0,f(r)}if(12==a.meta.scriptdatavalue){var H=r.getUint32(a.meta.pos,!1);a.meta.pos+=4;var j=n(r,a.meta.pos,H);if(a.meta.pos+=H,a.meta.nexttype=!0,a.meta.ispairvalue){var _=u();"strictarray"==a.meta.LevelsEnd[a.meta.LevelsEnd.length-1].typ?_.push(j):_[a.meta.pairkey]=j}f(r)}p(a.meta.scriptdatavalue,S)||(a.parseMetaDataBREAK=!0,a.meta.pos=a.tag.datasize+y+11)}else if(y+a.FileOffBuff<a.filesize){var W=y+a.FileOffBuff;m(W,t)}else delete a.tags,delete a.tag,delete a.meta,d(),t(null,a);p(B,L)||(a.parseFlagsBREAK=!0,y=a.BuffLength,a.FileOffBuff=a.filesize),y+=15+a.tag.datasize}if(y+a.FileOffBuff<a.filesize){var W=y+a.FileOffBuff;m(W,t)}else delete a.tags,delete a.tag,delete a.meta,d(),t(null,a)})}var c=0,v=8,g=9,h=18,y=250,L=[c,v,g,h,y],A=["Linear PCM, platform endian","ADPCM","MP3","Linear PCM, little endian","Nellymoser 16 kHz mono","Nellymoser 8 kHz mono","Nellymoser","G.711 A-law logarithmic PCM","G.711 mu-law logarithmic PCM","reserved","AAC","unknown","unknown","Speex","MP3 8 kHz","Device-specific sound"],C=[5.5,11.025,22.05,44.1],E=[8,16],F=["mono","stereo"],M=["unknown","unknown","Sorenson H.263","Screen video","On2 VP6","On2 VP6 with alpha channel","Screen video version 2","AVC","unknown","unknown","unknown","unknown","HEVC"],B=262144,S=[0,1,2,3,7,8,10,11,12],w=["Main Profile (MP)","Low Complexity (LC)","Scalable Sampling Rate profile (SSR)","Long Term Prediction (LPT)","Spectral Band Replication (SBR)","AAC Scalable"],P=[96,88.2,64,48,44.1,32,24,22.05,16,12,11.025,8,7.35],U=["unknown",[1,"FC"],[2,"FL/FR"],[3,"FC/FL/FR"],[4,"FC/FL/FR/BC"],[5,"FR/FL/FR/BL/BR"],[6,"FC/FL/FR/BL/BR/LFE-channel"],[8,"FC/FL/FR/SL/SR/BL/BR/LFE-channel"]];m(0,function(e){e?t(e):t(null,a)})};var o=function(e){this.type=e||o.OPEN_URI,this.size=null,this.file=null};if(o.OPEN_FILE=1,o.OPEN_URI=2,o.OPEN_LOCAL=3,"function"==typeof require)var s=require("fs");if(o.prototype.open=function(e,t){this.file=e;var a=this;switch(this.type){case o.OPEN_LOCAL:s.stat(this.file,function(e,i){return e?t(e):(a.size=i.size,void s.open(a.file,"r",function(e,i){return e?t(e):(a.fd=i,void t())}))});break;case o.OPEN_FILE:this.size=this.file.size,t();break;default:this.ajax({uri:this.file,type:"HEAD"},function(e,i,n){return e?t(e):(a.size=parseInt(n.getResponseHeader("Content-Length")),void t())})}},o.prototype.close=function(){this.type===o.OPEN_LOCAL&&s.close(this.fd)},o.prototype.read=function(e,t,a){"function"==typeof t&&(a=t,t=0),this.type===o.OPEN_LOCAL?this.readLocal(e,t,a):this.type===o.OPEN_FILE?this.readFile(e,t,a):this.readUri(e,t,a)},o.prototype.readBlob=function(e,t,a,i){"function"==typeof t?(i=t,t=0):"function"==typeof a&&(i=a,a="application/octet-stream"),this.read(e,t,function(e,t){return e?void i(e):void i(null,new Blob([t],{type:a}))})},o.prototype.readLocal=function(e,t,a){var i=new Buffer(e);s.read(this.fd,i,0,e,t,function(e,t,i){if(e)return a(e);for(var n=new ArrayBuffer(i.length),r=new Uint8Array(n),o=0;o<i.length;o++)r[o]=i[o];a(null,n)})},o.prototype.ajax=function(e,t){var a={type:"GET",uri:null,responseType:"text"};"string"==typeof e&&(e={uri:e});for(var i in e)a[i]=e[i];var n=new XMLHttpRequest;n.onreadystatechange=function(){return 4===n.readyState?200!==n.status&&206!==n.status?t("Received non-200/206 response ("+n.status+")"):void t(null,n.response,n):void 0},n.responseType=a.responseType,n.open(a.type,a.uri,!0),a.range&&(a.range=[].concat(a.range),2===a.range.length?n.setRequestHeader("Range","bytes="+a.range[0]+"-"+a.range[1]):n.setRequestHeader("Range","bytes="+a.range[0])),n.send()},o.prototype.readUri=function(e,t,a){this.ajax({uri:this.file,type:"GET",responseType:"arraybuffer",range:[t,t+e-1]},function(e,t){return e?a(e):a(null,t)})},o.prototype.readFile=function(e,t,a){if("undefined"==typeof FileReader){var i=this.file.slice(t,t+e),n=new FileReaderSync;a(null,n.readAsArrayBuffer(i))}else{var i=this.file.slice(t,t+e),n=new FileReader;n.onload=function(e){a(null,e.target.result)},n.readAsArrayBuffer(i)}},"string"==typeof i.type)switch(i.type){case"file":i.type=o.OPEN_FILE;break;case"local":i.type=o.OPEN_LOCAL;break;default:i.type=o.OPEN_URI}var l=new o(i.type);l.open(i.file,function(e){return e?t("Could not open specified file"):void r.parse(l,function(e,a){t(e,a)})})};"undefined"!=typeof module&&module.exports?module.exports=flv:"function"==typeof define&&define.amd&&define("flv",[],function(){return flv});